// Prisma ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®š
import { PrismaClient } from '@prisma/client';

const globalForPrisma = globalThis as unknown as {
  prisma: PrismaClient | undefined;
};

export const prisma = globalForPrisma.prisma ?? new PrismaClient({
  log: ['query', 'error', 'warn'],
  errorFormat: 'pretty',
});

if (process.env.NODE_ENV !== 'production') globalForPrisma.prisma = prisma;

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ†ã‚¹ãƒˆ
export async function testDatabaseConnection() {
  try {
    await prisma.$connect();
    console.log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ­£å¸¸ã«æ¥ç¶šã—ã¾ã—ãŸ');
    return true;
  } catch (error) {
    console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
    return false;
  } finally {
    await prisma.$disconnect();
  }
}

// ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ãƒ»ã‚·ãƒ¼ãƒ‰é–¢æ•°
export async function seedDatabase() {
  try {
    console.log('ğŸŒ± ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ã‚’é–‹å§‹...');

    // ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä½œæˆ
    const adminUser = await prisma.user.upsert({
      where: { username: 'admin' },
      update: {},
      create: {
        username: 'admin',
        userId: 'admin',
        password: '$2a$12$LQv3c1yqBw2/XVVQT4v1c.uXXr.O1Z5I2HrKtE3P/h9p8zVmIo5KS', // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: admin123
        authority: 'ç®¡ç†è€…',
      },
    });

    console.log('ğŸ‘¤ ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã—ã¾ã—ãŸ:', adminUser.username);

    // ã‚µãƒ³ãƒ—ãƒ«æ‹…å½“è€…ã®ä½œæˆ
    const sampleStaff = await prisma.staff.upsert({
      where: { code: 'STAFF001' },
      update: {},
      create: {
        code: 'STAFF001',
        name: 'ç”°ä¸­å¤ªéƒ',
        salesCommission: true,
        inspectionApproval: 'ä¸»ä»»',
      },
    });

    console.log('ğŸ‘· ã‚µãƒ³ãƒ—ãƒ«æ‹…å½“è€…ã‚’ä½œæˆã—ã¾ã—ãŸ:', sampleStaff.name);

    // ã‚µãƒ³ãƒ—ãƒ«å¾—æ„å…ˆã®ä½œæˆ
    const sampleCustomer = await prisma.customer.upsert({
      where: { code: 'CUST001' },
      update: {},
      create: {
        code: 'CUST001',
        name: 'æ ªå¼ä¼šç¤¾ã‚µãƒ³ãƒ—ãƒ«å•†äº‹',
        honorific: 'å¾¡ä¸­',
        postalCode: '123-4567',
        address: 'æ±äº¬éƒ½æ¸‹è°·åŒºã‚µãƒ³ãƒ—ãƒ«1-2-3',
        tel: '03-1234-5678',
        email: 'sample@example.com',
        contactPerson: 'ä½è—¤èŠ±å­',
        closingDate: 25,
        paymentDate: 10,
        comment: 'ã‚µãƒ³ãƒ—ãƒ«ã®å¾—æ„å…ˆã§ã™',
      },
    });

    console.log('ğŸ¢ ã‚µãƒ³ãƒ—ãƒ«å¾—æ„å…ˆã‚’ä½œæˆã—ã¾ã—ãŸ:', sampleCustomer.name);

    // ã‚µãƒ³ãƒ—ãƒ«ä»•å…¥å…ˆã®ä½œæˆ
    const sampleSupplier = await prisma.supplier.upsert({
      where: { code: 'SUPP001' },
      update: {},
      create: {
        code: 'SUPP001',
        name: 'æ¶ˆé˜²æ©Ÿå™¨è²©å£²æ ªå¼ä¼šç¤¾',
        honorific: 'å¾¡ä¸­',
        postalCode: '456-7890',
        address: 'æ„›çŸ¥çœŒåå¤å±‹å¸‚ä¸­åŒºä»•å…¥1-2-3',
        tel: '052-1234-5678',
        email: 'order@supplier.com',
        contactPerson: 'å±±ç”°æ¬¡éƒ',
        comment: 'ä¸»è¦ä»•å…¥å…ˆ',
      },
    });

    console.log('ğŸ­ ã‚µãƒ³ãƒ—ãƒ«ä»•å…¥å…ˆã‚’ä½œæˆã—ã¾ã—ãŸ:', sampleSupplier.name);

    // ã‚µãƒ³ãƒ—ãƒ«å•†å“ã®ä½œæˆ
    const sampleProducts = [
      {
        code: 'PROD001',
        name: 'æ¶ˆç«å™¨ABCç²‰æœ«10å‹',
        unit: 'æœ¬',
        category: 'æ¶ˆç«å™¨',
        price: 15000,
        purchasePrice: 12000,
        stockQuantity: 50,
        supplierId: sampleSupplier.id,
      },
      {
        code: 'PROD002',
        name: 'è‡ªå‹•ç«ç½å ±çŸ¥è¨­å‚™æ„ŸçŸ¥å™¨',
        unit: 'å€‹',
        category: 'ç«ç½å ±çŸ¥è¨­å‚™',
        price: 25000,
        purchasePrice: 20000,
        stockQuantity: 30,
        supplierId: sampleSupplier.id,
      },
      {
        code: 'PROD003',
        name: 'ã‚¹ãƒ—ãƒªãƒ³ã‚¯ãƒ©ãƒ¼ãƒ˜ãƒƒãƒ‰',
        unit: 'å€‹',
        category: 'ã‚¹ãƒ—ãƒªãƒ³ã‚¯ãƒ©ãƒ¼',
        price: 8000,
        purchasePrice: 6000,
        stockQuantity: 100,
        supplierId: sampleSupplier.id,
      },
    ];

    for (const productData of sampleProducts) {
      await prisma.product.upsert({
        where: { code: productData.code },
        update: {},
        create: productData,
      });
    }

    console.log('ğŸ“¦ ã‚µãƒ³ãƒ—ãƒ«å•†å“ã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆ3ä»¶ï¼‰');

    console.log('ğŸ‰ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®åˆæœŸåŒ–ãŒå®Œäº†ã—ã¾ã—ãŸï¼');
    return true;
  } catch (error) {
    console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
    return false;
  }
}